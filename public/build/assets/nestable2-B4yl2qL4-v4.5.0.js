/*!
 * Nestable jQuery Plugin - Copyright (c) 2014 Ramon Smit - https://github.com/RamonSmit/Nestable
 */(function(l,g,u,N){var C="ontouchstart"in u,E=function(){var t=u.createElement("div"),e=u.documentElement;if(!("pointerEvents"in t.style))return!1;t.style.pointerEvents="auto",t.style.pointerEvents="x",e.appendChild(t);var a=g.getComputedStyle&&g.getComputedStyle(t,"").pointerEvents==="auto";return e.removeChild(t),!!a}(),b={contentCallback:function(t){return t.content?t.content:t.id},listNodeName:"ol",itemNodeName:"li",handleNodeName:"div",contentNodeName:"span",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",contentClass:"dd-content",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",noChildrenClass:"dd-nochildren",emptyClass:"dd-empty",expandBtnHTML:'<button class="dd-expand" data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button class="dd-collapse" data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,fixedDepth:!1,fixed:!1,includeContent:!1,scroll:!1,scrollSensitivity:1,scrollSpeed:5,scrollTriggers:{top:40,left:40,right:-40,bottom:-40},effect:{animation:"none",time:"slow"},callback:function(t,e,a){},onDragStart:function(t,e,a){},beforeDragStop:function(t,e,a){},listRenderer:function(t,e){var a="<"+e.listNodeName+' class="'+e.listClass+'">';return a+=t,a+="</"+e.listNodeName+">",a},itemRenderer:function(t,e,a,n,r){var o=l.map(t,function(i,d){return" "+d+'="'+i+'"'}).join(" "),s="<"+n.itemNodeName+o+">";return s+="<"+n.handleNodeName+' class="'+n.handleClass+'">',s+="<"+n.contentNodeName+' class="'+n.contentClass+'">',s+=e,s+="</"+n.contentNodeName+">",s+="</"+n.handleNodeName+">",s+=a,s+="</"+n.itemNodeName+">",s}};function y(t,e){this.w=l(u),this.el=l(t),e=e||b,e.rootClass!==N&&e.rootClass!=="dd"&&(e.listClass=e.listClass?e.listClass:e.rootClass+"-list",e.itemClass=e.itemClass?e.itemClass:e.rootClass+"-item",e.dragClass=e.dragClass?e.dragClass:e.rootClass+"-dragel",e.handleClass=e.handleClass?e.handleClass:e.rootClass+"-handle",e.collapsedClass=e.collapsedClass?e.collapsedClass:e.rootClass+"-collapsed",e.placeClass=e.placeClass?e.placeClass:e.rootClass+"-placeholder",e.noDragClass=e.noDragClass?e.noDragClass:e.rootClass+"-nodrag",e.noChildrenClass=e.noChildrenClass?e.noChildrenClass:e.rootClass+"-nochildren",e.emptyClass=e.emptyClass?e.emptyClass:e.rootClass+"-empty"),this.options=l.extend({},b,e),this.options.json!==N&&this._build(),this.init()}y.prototype={init:function(){var t=this;t.reset(),t.el.data("nestable-group",this.options.group),t.placeEl=l('<div class="'+t.options.placeClass+'"/>');var e=this.el.find(t.options.itemNodeName);l.each(e,function(s,i){var d=l(i),h=d.parent();t.setParent(d),h.hasClass(t.options.collapsedClass)&&t.collapseItem(h.parent())}),e.length||this.appendEmptyElement(this.el),t.el.on("click","button",function(s){if(!t.dragEl){var i=l(s.currentTarget),d=i.data("action"),h=i.parents(t.options.itemNodeName).eq(0);d==="collapse"&&t.collapseItem(h),d==="expand"&&t.expandItem(h)}});var a=function(s){var i=l(s.target);if(!i.hasClass(t.options.handleClass)){if(i.closest("."+t.options.noDragClass).length)return;i=i.closest("."+t.options.handleClass)}!i.length||t.dragEl||(t.isTouch=/^touch/.test(s.type),!(t.isTouch&&s.touches.length!==1)&&(s.preventDefault(),t.dragStart(s.touches?s.touches[0]:s)))},n=function(s){t.dragEl&&(s.preventDefault(),t.dragMove(s.touches?s.touches[0]:s))},r=function(s){t.dragEl&&(s.preventDefault(),t.dragStop(s.touches?s.changedTouches[0]:s))};C&&(t.el[0].addEventListener("touchstart",a,!1),g.addEventListener("touchmove",n,!1),g.addEventListener("touchend",r,!1),g.addEventListener("touchcancel",r,!1)),t.el.on("mousedown",a),t.w.on("mousemove",n),t.w.on("mouseup",r);var o=function(){C&&(t.el[0].removeEventListener("touchstart",a,!1),g.removeEventListener("touchmove",n,!1),g.removeEventListener("touchend",r,!1),g.removeEventListener("touchcancel",r,!1)),t.el.off("mousedown",a),t.w.off("mousemove",n),t.w.off("mouseup",r),t.el.off("click"),t.el.unbind("destroy-nestable"),t.el.data("nestable",null)};t.el.bind("destroy-nestable",o)},destroy:function(){this.el.trigger("destroy-nestable")},add:function(t){var e="."+this.options.listClass,a=l(this.el).children(e);t.parent_id!==N&&(a=a.find('[data-id="'+t.parent_id+'"]'),delete t.parent_id,a.children(e).length===0&&(a=a.append(this.options.listRenderer("",this.options))),a=a.find(e+":first"),this.setParent(a.parent())),a.append(this._buildItem(t,this.options))},replace:function(t){var e=this._buildItem(t,this.options);this._getItemById(t.id).replaceWith(e)},removeItem:function(t){var e=this.options,a=this.el;t=t||this,t.remove();var n="."+e.listClass+" ."+e.listClass+":not(:has(*))";l(a).find(n).remove();var r='[data-action="expand"], [data-action="collapse"]';l(a).find(r).each(function(){var o=l(this).siblings("."+e.listClass);o.length===0&&l(this).remove()})},remove:function(t,e){var a=this.options,n=this,r=this._getItemById(t),o=a.effect.animation||"fade",s=a.effect.time||"slow";o==="fade"?r.fadeOut(s,function(){n.removeItem(r)}):this.removeItem(r),e&&e()},removeAll:function(t){var e=this,a=this.options,n=e.el.find(a.listNodeName).first(),r=n.children(a.itemNodeName),o=a.effect.animation||"fade",s=a.effect.time||"slow";function i(){r.each(function(){e.removeItem(l(this))}),n.show(),t&&t()}o==="fade"?n.fadeOut(s,i):i()},_getItemById:function(t){return l(this.el).children("."+this.options.listClass).find('[data-id="'+t+'"]')},_build:function(){var t=this.options.json;typeof t=="string"&&(t=JSON.parse(t)),l(this.el).html(this._buildList(t,this.options))},_buildList:function(t,e){if(!t)return"";var a="",n=this;return l.each(t,function(r,o){a+=n._buildItem(o,e)}),e.listRenderer(a,e)},_buildItem:function(t,e){function a(f){var p={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return f+"".replace(/[&<>"']/g,function(c){return p[c]})}function n(f){var p={};for(var c in f)p[f[c]]=f[c];return p}function r(f,p){var c=f.classes||{};typeof c=="string"&&(c=[c]);var m=n(c);return m[p.itemClass]=p.itemClass,l.map(m,function(v){return v}).join(" ")}function o(f){f=l.extend({},f),delete f.children,delete f.classes,delete f.content;var p={};return l.each(f,function(c,m){typeof m=="object"&&(m=JSON.stringify(m)),p["data-"+c]=a(m)}),p}var s=o(t);s.class=r(t,e);var i=e.contentCallback(t),d=this._buildList(t.children,e),h=l(e.itemRenderer(s,i,d,e,t));return this.setParent(h),h[0].outerHTML},serialize:function(){var t,e=this,a=function(n){var r=[],o=n.children(e.options.itemNodeName);return o.each(function(){var s=l(this),i=l.extend({},s.data()),d=s.children(e.options.listNodeName);if(e.options.includeContent){var h=s.find("."+e.options.contentClass).html();h&&(i.content=h)}d.length&&(i.children=a(d)),r.push(i)}),r};return t=a(e.el.find(e.options.listNodeName).first()),t},asNestedSet:function(){var t=this,e=t.options,a=-1,n=[],r=1,o=t.el.find(e.listNodeName).first().children(e.itemNodeName);return o.each(function(){r=s(this,a+1,r)}),n=n.sort(function(d,h){return d.lft-h.lft}),n;function s(d,h,f){var p=f+1,c,m;return l(d).children(e.listNodeName).children(e.itemNodeName).length>0&&(h++,l(d).children(e.listNodeName).children(e.itemNodeName).each(function(){p=s(l(this),h,p)}),h--),c=l(d).attr("data-id"),i(c)&&(c=parseInt(c)),m=l(d).parent(e.listNodeName).parent(e.itemNodeName).attr("data-id")||"",i(m)&&(c=parseInt(m)),c&&n.push({id:c,parent_id:m,depth:h,lft:f,rgt:p}),f=p+1,f}function i(d){return l.isNumeric(d)&&Math.floor(d)==d}},returnOptions:function(){return this.options},serialise:function(){return this.serialize()},toHierarchy:function(t){var e=l.extend({},this.options,t),a=[];return l(this.element).children(e.items).each(function(){var r=n(this);a.push(r)}),a;function n(r){var o=(l(r).attr(e.attribute||"id")||"").match(e.expression||/(.+)[-=_](.+)/);if(o){var s={id:o[2]};return l(r).children(e.listType).children(e.items).length>0&&(s.children=[],l(r).children(e.listType).children(e.items).each(function(){var i=n(this);s.children.push(i)})),s}}},toArray:function(){var t=l.extend({},this.options,this),e=t.startDepthCount||0,a=[],n=2,r=this,o=r.el.find(r.options.listNodeName).first(),s=o.children(r.options.itemNodeName);return s.each(function(){n=i(l(this),e+1,n)}),a=a.sort(function(d,h){return d.left-h.left}),a;function i(d,h,f){var p=f+1,c,m;if(d.children(t.options.listNodeName).children(t.options.itemNodeName).length>0&&(h++,d.children(t.options.listNodeName).children(t.options.itemNodeName).each(function(){p=i(l(this),h,p)}),h--),c=d.data().id,h===e+1)m=t.rootID;else{var v=d.parent(t.options.listNodeName).parent(t.options.itemNodeName).data();m=v.id}return c&&a.push({id:c,parent_id:m,depth:h,left:f,right:p}),f=p+1,f}},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(t){t.removeClass(this.options.collapsedClass)},collapseItem:function(t){var e=t.children(this.options.listNodeName);e.length&&t.addClass(this.options.collapsedClass)},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(l(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(l(this))})},setParent:function(t){t.is(this.options.itemNodeName)&&t.children(this.options.listNodeName).length&&(t.children("[data-action]").remove(),t.prepend(l(this.options.expandBtnHTML)),t.prepend(l(this.options.collapseBtnHTML)))},unsetParent:function(t){t.removeClass(this.options.collapsedClass),t.children("[data-action]").remove(),t.children(this.options.listNodeName).remove()},dragStart:function(t){var e=this.mouse,a=l(t.target),n=a.closest(this.options.itemNodeName),r={top:t.pageY,left:t.pageX},o=this.options.onDragStart.call(this,this.el,n,r);if(!(typeof o<"u"&&o===!1)){this.placeEl.css("height",n.height()),e.offsetX=t.pageX-n.offset().left,e.offsetY=t.pageY-n.offset().top,e.startX=e.lastX=t.pageX,e.startY=e.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=l(u.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",n.outerWidth()),this.setIndexOfItem(n),n.after(this.placeEl),n[0].parentNode.removeChild(n[0]),n.appendTo(this.dragEl),l(u.body).append(this.dragEl),this.dragEl.css({left:t.pageX-e.offsetX,top:t.pageY-e.offsetY});var s,i,d=this.dragEl.find(this.options.itemNodeName);for(s=0;s<d.length;s++)i=l(d[s]).parents(this.options.listNodeName).length,i>this.dragDepth&&(this.dragDepth=i)}},createSubLevel:function(t,e){var a=l("<"+this.options.listNodeName+"/>").addClass(this.options.listClass);return e&&a.append(e),t.append(a),this.setParent(t),a},setIndexOfItem:function(t,e){e=e||[],e.unshift(t.index()),l(t[0].parentNode)[0]!==this.dragRootEl[0]?this.setIndexOfItem(l(t[0].parentNode),e):this.dragEl.data("indexOfItem",e)},restoreItemAtIndex:function(t,e){var a=this.el,n=e.length-1;function r(d,h){e[n]===0?l(d).prepend(h.clone(!0)):l(d.children[e[n]-1]).after(h.clone(!0))}for(var o=0;o<e.length;o++){if(n===parseInt(o)){r(a,t);return}var s=a[0]?a[0]:a,i=s.children[e[o]];a=i||this.createSubLevel(l(s))}},dragStop:function(t){var e={top:t.pageY,left:t.pageX},a=this.dragEl.data("indexOfItem"),n=this.dragEl.children(this.options.itemNodeName).first();n[0].parentNode.removeChild(n[0]),this.dragEl.remove();var r=this.options.beforeDragStop.call(this,this.el,n,this.placeEl.parent());if(typeof r<"u"&&r===!1){var o=this.placeEl.parent();this.placeEl.remove(),o.children().length||this.unsetParent(o.parent()),this.restoreItemAtIndex(n,a),this.reset();return}this.placeEl.replaceWith(n),this.hasNewRoot?(this.options.fixed===!0?this.restoreItemAtIndex(n,a):this.el.trigger("lostItem"),this.dragRootEl.trigger("gainedItem")):this.dragRootEl.trigger("change"),this.options.callback.call(this,this.dragRootEl,n,e),this.reset()},dragMove:function(t){var e,a,n,r,o,s=this.options,i=this.mouse;this.dragEl.css({left:t.pageX-i.offsetX,top:t.pageY-i.offsetY}),i.lastX=i.nowX,i.lastY=i.nowY,i.nowX=t.pageX,i.nowY=t.pageY,i.distX=i.nowX-i.lastX,i.distY=i.nowY-i.lastY,i.lastDirX=i.dirX,i.lastDirY=i.dirY,i.dirX=i.distX===0?0:i.distX>0?1:-1,i.dirY=i.distY===0?0:i.distY>0?1:-1;var d=Math.abs(i.distX)>Math.abs(i.distY)?1:0;if(!i.moving){i.dirAx=d,i.moving=!0;return}if(s.scroll)if(typeof g.jQuery.fn.scrollParent<"u"){var h=!1,f=this.el.scrollParent()[0];f!==u&&f.tagName!=="HTML"?(s.scrollTriggers.bottom+f.offsetHeight-t.pageY<s.scrollSensitivity?f.scrollTop=h=f.scrollTop+s.scrollSpeed:t.pageY-s.scrollTriggers.top<s.scrollSensitivity&&(f.scrollTop=h=f.scrollTop-s.scrollSpeed),s.scrollTriggers.right+f.offsetWidth-t.pageX<s.scrollSensitivity?f.scrollLeft=h=f.scrollLeft+s.scrollSpeed:t.pageX-s.scrollTriggers.left<s.scrollSensitivity&&(f.scrollLeft=h=f.scrollLeft-s.scrollSpeed)):(t.pageY-l(u).scrollTop()<s.scrollSensitivity?h=l(u).scrollTop(l(u).scrollTop()-s.scrollSpeed):l(g).height()-(t.pageY-l(u).scrollTop())<s.scrollSensitivity&&(h=l(u).scrollTop(l(u).scrollTop()+s.scrollSpeed)),t.pageX-l(u).scrollLeft()<s.scrollSensitivity?h=l(u).scrollLeft(l(u).scrollLeft()-s.scrollSpeed):l(g).width()-(t.pageX-l(u).scrollLeft())<s.scrollSensitivity&&(h=l(u).scrollLeft(l(u).scrollLeft()+s.scrollSpeed)))}else console.warn("To use scrolling you need to have scrollParent() function, check documentation for more information");this.scrollTimer&&clearTimeout(this.scrollTimer),s.scroll&&h&&(this.scrollTimer=setTimeout(function(){l(g).trigger(t)},10)),i.dirAx!==d?(i.distAxX=0,i.distAxY=0):(i.distAxX+=Math.abs(i.distX),i.dirX!==0&&i.dirX!==i.lastDirX&&(i.distAxX=0),i.distAxY+=Math.abs(i.distY),i.dirY!==0&&i.dirY!==i.lastDirY&&(i.distAxY=0)),i.dirAx=d,i.dirAx&&i.distAxX>=s.threshold&&(i.distAxX=0,n=this.placeEl.prev(s.itemNodeName),i.distX>0&&n.length&&!n.hasClass(s.collapsedClass)&&!n.hasClass(s.noChildrenClass)&&(e=n.find(s.listNodeName).last(),o=this.placeEl.parents(s.listNodeName).length,o+this.dragDepth<=s.maxDepth&&(e.length?(e=n.children(s.listNodeName).last(),e.append(this.placeEl)):this.createSubLevel(n,this.placeEl))),i.distX<0&&(r=this.placeEl.next(s.itemNodeName),r.length||(a=this.placeEl.parent(),this.placeEl.closest(s.itemNodeName).after(this.placeEl),a.children().length||this.unsetParent(a.parent()))));var p=!1;if(E||(this.dragEl[0].style.visibility="hidden"),this.pointEl=l(u.elementFromPoint(t.pageX-u.body.scrollLeft,t.pageY-(g.pageYOffset||u.documentElement.scrollTop))),E||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(s.handleClass)&&(this.pointEl=this.pointEl.closest(s.itemNodeName)),this.pointEl.hasClass(s.emptyClass))p=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(s.itemClass))return;var c=this.pointEl.closest("."+s.rootClass),m=this.dragRootEl.data("nestable-id")!==c.data("nestable-id");if(!i.dirAx||m||p){if(m&&s.group!==c.data("nestable-group")||this.options.fixedDepth&&this.dragDepth+1!==this.pointEl.parents(s.listNodeName).length||(o=this.dragDepth-1+this.pointEl.parents(s.listNodeName).length,o>s.maxDepth))return;var v=t.pageY<this.pointEl.offset().top+this.pointEl.height()/2;a=this.placeEl.parent(),p?(e=l(u.createElement(s.listNodeName)).addClass(s.listClass),e.append(this.placeEl),this.pointEl.replaceWith(e)):v?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),a.children().length||this.unsetParent(a.parent()),this.dragRootEl.find(s.itemNodeName).length||this.appendEmptyElement(this.dragRootEl),this.dragRootEl=c,m&&(this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}},appendEmptyElement:function(t){t.append('<div class="'+this.options.emptyClass+'"/>')}},l.fn.nestable=function(t){var e=this,a=this,n=arguments;return"Nestable"in g||(g.Nestable={},Nestable.counter=0),e.each(function(){var r=l(this).data("nestable");if(!r)Nestable.counter++,l(this).data("nestable",new y(this,t)),l(this).data("nestable-id",Nestable.counter);else if(typeof t=="string"&&typeof r[t]=="function")if(n.length>1){for(var o=[],s=1;s<n.length;s++)o.push(n[s]);a=r[t].apply(r,o)}else a=r[t]()}),a||e}})(window.jQuery||window.Zepto,window,document);
